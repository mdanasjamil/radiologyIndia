{% load static tz %}
<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
{#  <link rel="stylesheet" href="{% static 'css/portal.css' %}">#}
  <title>Doctor Dashboard</title>
  <style>
      .btn-report {
  display: inline-block;
  background: #28a745;
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  text-decoration: none;
  font-size: 0.9rem;
}
.btn-report:hover {
  background: #218838;
}

.btn-edit {
  display: inline-block;
  background: #ffc107;
  color: #000;
  padding: 4px 8px;
  border-radius: 4px;
  text-decoration: none;
  font-size: 0.8rem;
  margin-left: 6px;
}
.btn-edit:hover {
  background: #e0a800;
}
    body { margin:0; font-family: 'Segoe UI',sans-serif; background:#f4f6f8; }
    .navbar { display:flex; justify-content:space-between; align-items:center; background:#036; color:#fff; padding:10px 20px; }
    .navbar .logo { font-size:1.5rem; }
    .navbar .profile-pic { width:40px; height:40px; border-radius:50%; }
    .dropdown { position:relative; display:inline-block; }
    .dropbtn { background:none; border:none; color:#fff; font-size:1rem; cursor:pointer; }
    .dropdown-content { display:none; position:absolute; right:0; background:#fff; min-width:120px; box-shadow:0 4px 8px rgba(0,0,0,0.2); }
    .dropdown-content a { color:#333; padding:8px 12px; display:block; text-decoration:none; }
    .dropdown-content a:hover { background:#eee; }
    .dropdown:hover .dropdown-content { display:block; }

    .controls { display:flex; justify-content:space-between; padding:15px 20px; background:#fff; border-bottom:1px solid #ddd; }
    .filter-form select, .filter-form input, .filter-form button { margin-right:10px; padding:6px 12px; border:1px solid #ccc; border-radius:4px; }
    .filter-form input { width:80px; }

    .table-container { padding:20px; overflow-x:auto; }
    table { width:100%; border-collapse:collapse; background:#fff; }
    th, td { padding:10px; border:1px solid #ddd; text-align:left; }
    th { background:#f0f0f0; }
    th a { color: inherit; text-decoration: none; font-weight: bold; }
    .arrow { font-size:0.7em; margin-left:4px; }
    th.sorted { background:#e0eaff; }

    .btn-add, .btn-save, .btn-cancel, .btn-assign { padding:8px 15px; border:none; border-radius:4px; color:#fff; cursor:pointer; }
    .btn-add { background:#036; }
    .btn-save { background:green; }
    .btn-cancel { background:red; }
    .btn-assign { background:#028; margin-left:5px; padding:4px 8px; }

    /* Centering modal */
    .modal {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.4);
      display:flex;               /* flex container */
      align-items:center;         /* vertical center */
      justify-content:center;     /* horizontal center */
      z-index:1000;
    }
    .modal-content {
      background:#fff; padding:20px; border-radius:8px;
      width:400px; position:relative;
    }
    .modal-content .close { position:absolute; top:10px; right:15px; font-size:1.5rem; cursor:pointer; }
  </style>
</head><body>

<nav class="navbar">
  <div class="logo">Radiology Portal</div>
  <div class="dropdown">
    <button class="dropbtn">{{ request.user.username }}</button>
    <div class="dropdown-content">
      <a href="#">Profile</a>
      <a href="{% url 'accounts:logout' %}">Logout</a>
    </div>
  </div>
</nav>

<header class="controls">
  <form method="get" class="filter-form">
    <input type="text" name="q" value="{{ filters.q }}" placeholder="Search name or ID">
    <select name="status">
      <option value="">All Status</option>
      <option value="unassigned" {% if filters.status == 'unassigned' %}selected{% endif %}>Unassigned</option>
      <option value="assigned"   {% if filters.status == 'assigned'   %}selected{% endif %}>Assigned</option>
      <option value="reported"   {% if filters.status == 'reported'   %}selected{% endif %}>Reported</option>
    </select>
    <select name="modality">
      <option value="">All Modality</option>
      {% for v,l in Patient.MODALITY_CHOICES %}
        <option value="{{v}}" {% if filters.modality == v %}selected{% endif %}>{{l}}</option>
      {% endfor %}
    </select>
    <select name="sex">
      <option value="">Any Sex</option>
      <option value="Male" {% if filters.sex == 'Male'%}selected{% endif %}>Male</option>
      <option value="Female" {% if filters.sex == 'Female'%}selected{% endif %}>Female</option>
    </select>
    <input type="number" name="age_min" value="{{filters.age_min}}" placeholder="Min age">
    – 
    <input type="number" name="age_max" value="{{filters.age_max}}" placeholder="Max age">
    <button type="submit">Apply Filters</button>
  </form>
</header>

<main class="table-container">
    <table>
      <thead>
        <tr>
          <th>Status</th>
          <th class="{% if sort == 'patient_id' %}sorted{% endif %}">
            <a href="?sort=patient_id&dir={% if sort == 'patient_id' and dir == 'asc' %}desc{% else %}asc{% endif %}">
              Patient Id
              {% if sort == 'patient_id' %}
                <span class="arrow">{% if dir == 'asc' %}↑{% else %}↓{% endif %}</span>
              {% endif %}
            </a>
          </th>
          <th>Name</th>
          <th>Age</th>
          <th>Sex</th>
          <th>Mod</th>
          <th>Study Type</th>
          <th class="{% if sort == 'receiving_date' %}sorted{% endif %}">
            <a href="?sort=receiving_date&dir={% if sort == 'receiving_date' and dir == 'asc' %}desc{% else %}asc{% endif %}">
              Received
              {% if sort == 'receiving_date' %}
                <span class="arrow">{% if dir == 'asc' %}↑{% else %}↓{% endif %}</span>
              {% endif %}
            </a>
          </th>
          <th>Img</th>
          <th>Report</th>
          <th>StudyDate</th>
          <th>Physician</th>
          <th>Report Time</th>
          <th>Institution</th>
        </tr>
      </thead>
<tbody>
  {% for p, form in patient_form_pairs %}
    <tr>
      <td>{{ p.status }}</td>
      <td><a href="{% url 'doctor:doctor_download' p.patient_id %}">{{ p.patient_id }}</a></td>
      <td>{{ p.patient_name }}</td>
      <td>{{ p.age }}</td>
      <td>{{ p.sex }}</td>
      <td>{{ p.modality }}</td>
      <td>{{ p.study_type }}</td>
      <td>{{ p.receiving_date|date:"Y-m-d H:i" }}</td>
      <td>{{ p.number_of_images }}</td>
      <td>
  {% if p.status == 'reported' %}
    {% with rep=p.reports.last %}
      {% if rep %}
        <a 
          href="{% url 'doctor:download_report' p.patient_id %}" 
          class="btn-report"
        >
          Report #{{ rep.id }}
        </a>
        <a 
          href="{% url 'doctor:edit_report' p.patient_id %}" 
          class="btn-edit" 
          target="_blank"
        >
          Edit
        </a>
      {% endif %}
    {% endwith %}
  {% endif %}
</td>
      <td>{{ p.study_date|default:"-" }}</td>
      <td>{{ "Dr. " }}{{ p.preferred_physician.first_name }}{{ " " }}{{ p.preferred_physician.last_name }}</td>
      <td>{{ p.report_time|date:"Y-m-d H:i"|default:"-" }}</td>
      <td>{{ p.institution_name }}</td>
    </tr>
  {% empty %}
    <tr><td colspan="14">No patients found.</td></tr>
  {% endfor %}
</tbody>



    </table>
  </main> 

</body>
</html>
